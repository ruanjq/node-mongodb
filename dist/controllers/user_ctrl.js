"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.deleteUser=exports.findAllUser=exports.logout=exports.login=exports.signup=exports.uploadAvatar=void 0;var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_user_models=require("../models/user_models"),_user_models2=_interopRequireDefault(_user_models),multer=require("multer"),path=require("path"),md5=require("md5"),uploadAvatar=exports.uploadAvatar=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,t){var n,s,u,a;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n="/upload",s=multer.diskStorage({destination:function(e,r,t){t(null,path.join(__dirname,"../../static",n))},filename:function(e,r,t){var s=r.mimetype.split("/")[1];r.storagePath=n,t(null,md5((0,_stringify2.default)(r))+"."+s)}}),u=function(){var e=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function e(r,n,s){var u;return _regenerator2.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,signupValid(r,t);case 3:u=e.sent,s(null,!0),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),s({code:0,data:e.t0},!1);case 10:case"end":return e.stop()}},e,void 0,[[0,7]])}));return function(r,t,n){return e.apply(this,arguments)}}(),a=multer({storage:s,fileFilter:u}).single("avatar"),e.abrupt("return",new _promise2.default(function(e,n){a(r,t,function(s){r.file?void 0==s?e():n(s.data):signupValid(r,t).then(function(r){e(r)}).catch(function(e){n(e)})})}));case 5:case"end":return e.stop()}},e,void 0)}));return function(r,t){return e.apply(this,arguments)}}(),signupValid=function(e,r){return new _promise2.default(function(r,t){var n=e.body;null!=n.username&&""!=n.username||t("用户名不为空!"),null!=n.pwd&&""!=n.pwd||t("密码不为空!"),null!=n.sex&&""!=n.sex||t("性别不为空!"),null!=n.birthday&&""!=n.birthday||t("生日不为空!"),n.birthday=new Date(n.birthday).getTime(),_user_models2.default.findOne({username:n.username}).then(function(e){e?t("该用户名已注册,请重新输入!"):r(n)}).catch(function(e){t("注册失败,请稍后再试!")})})},signup=exports.signup=function(e,r,t){uploadAvatar(e,r).then(function(){var t=e.body;if(t.birthday=new Date(t.birthday).getTime(),e.file){var n=e.file;t.avatar=n.storagePath+"/"+n.filename}_user_models2.default.add(t).then(function(t){login(e,r)})}).catch(function(e){r.json({status:0,msg:e})})},login=exports.login=function(e,r){var t=e.body;return null==t.username||""==t.username?r.json({status:0,msg:"用户名不为空!"}):null==t.pwd||""==t.pwd?r.json({status:0,msg:"密码不为空!"}):void _user_models2.default.findOne({username:t.username}).then(function(n){n?n.validPassword(t.pwd,function(t){return t?(e.session.user=n,r.json({status:1,msg:"登录成功"})):r.json({status:0,msg:"账号或密码错误"})}):r.json({status:0,msg:"账号或密码错误"})}).catch(function(e){return r.json({status:0,msg:"登录失败"})})},logout=exports.logout=function(e,r){r.clearCookie("USER_ID"),e.session.destroy(function(e){r.redirect("/")})},findAllUser=exports.findAllUser=function(e,r,t,n){_user_models2.default.find(!1,function(e,t){e&&console.log(e),r.render(n,{title:"Express",userList:t})})},deleteUser=exports.deleteUser=function(e,r,t){var n=e.params.id;if(!n)return r.redirect("/user/list");_user_models2.default.remove({_id:n}).then(function(e){r.redirect("/user/list")}).catch(function(e){r.redirect("/user/list")})};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL3VzZXJfY3RybC5qcyJdLCJuYW1lcyI6WyJfdXNlcl9tb2RlbHMiLCJyZXF1aXJlIiwibXVsdGVyIiwicGF0aCIsIm1kNSIsInVwbG9hZEF2YXRhciIsIl9yZWYiLCJfYXN5bmNUb0dlbmVyYXRvcjMiLCJkZWZhdWx0IiwiX3JlZ2VuZXJhdG9yMiIsIm1hcmsiLCJfY2FsbGVlMiIsInJlcSIsInJlcyIsInN0b3JhZ2VQYXRoIiwic3RvcmFnZSIsImZpbGVGaWx0ZXIiLCJ1cGxvYWQiLCJ3cmFwIiwiX2NvbnRleHQyIiwicHJldiIsIm5leHQiLCJkaXNrU3RvcmFnZSIsImRlc3RpbmF0aW9uIiwiZmlsZSIsImNiIiwiam9pbiIsIl9fZGlybmFtZSIsImZpbGVuYW1lIiwidHlwZSIsIm1pbWV0eXBlIiwic3BsaXQiLCJfc3RyaW5naWZ5MiIsIl9yZWYyIiwiX2NhbGxlZSIsInVzZXIiLCJfY29udGV4dCIsInNpZ251cFZhbGlkIiwic2VudCIsInQwIiwiY29kZSIsImRhdGEiLCJzdG9wIiwidW5kZWZpbmVkIiwiX3gzIiwiX3g0IiwiX3g1IiwiYXBwbHkiLCJ0aGlzIiwiYXJndW1lbnRzIiwic2luZ2xlIiwiYWJydXB0IiwiX3Byb21pc2UyIiwicmVzb2x2ZSIsInJlamVjdCIsImVyciIsInRoZW4iLCJfdXNlciIsIm1zZyIsIl94IiwiX3gyIiwidXNlcm5hbWUiLCJwd2QiLCJzZXgiLCJiaXJ0aGRheSIsIkRhdGUiLCJnZXRUaW1lIiwiX3VzZXJfbW9kZWxzMiIsImZpbmRPbmUiLCJkb2NzIiwiY2F0Y2giLCJfZmlsZSIsImxvZ2luIiwiZXJyTXNnIiwianNvbiIsInN0YXR1cyIsInBhcmFtcyIsImJvZHkiLCJ2YWxpZFBhc3N3b3JkIiwiaXNDaGVjayIsInNlc3Npb24iLCJkZXN0cm95IiwiZmluZEFsbFVzZXIiLCJyZXN1bHQiLCJ0ZW1wbGF0ZSIsInRpdGxlIiwidXNlckxpc3QiLCJzaWdudXAiLCJpZCIsIl9pZCIsInJlZGlyZWN0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QUEsY0FzREY3QyxFQUFBNkQsTUFBQUMsT0FBQSxFQUFZakIsSUFBQSxjQUVmWSxNQUFJYixTQUFBQSxHQUNBSCxPQUFBQSxFQUFPb0IsTUFBQUMsT0FBUCxFQUFBakIsSUFBQSxZQUtBRCxPQUFBQSxRQUFBQSxPQUFBLFNBQUE3QyxFQUFhQyxHQUNieUMsRUFBQUEsWUFBTyxXQUNWMUMsRUFBQW9FLFFBQUFDLFFBQUEsU0FBQTFCLEdBQ0QxQyxFQUFJNEMsU0FBTU8sUUFLVmtCLFlBQUFBLFFBQUFBLFlBQUEsU0FBQXRFLEVBQVF3RCxFQUFRL0MsRUFBRXdDLEdBRVZSLGNBQUFBLFFBQUFBLE1BQUFBLEVBQVFJLFNBQUFBLEVBQVIwQixHQUNINUIsR0FDR0QsUUFBQUEsSUFBT0MsR0FHWEQsRUFBQUEsT0FBTzhCLEdBQUFDLE1BQVAsVUFBQUMsU0FBQUgsT0FNQ0ksV0FBQUEsUUFBQUEsV0FBQUEsU0FBQUEsRUFBUzFFLEVBQUFRLEdBa0VsQixJQUFJbUUsRUFBSzVFLEVBQUlnRSxPQUFKLEdBaEVUdkUsSUFBQUEsRUFDSSxPQUFJb0QsRUFBQUEsU0FBSixjQUVBVSxjQUFBM0QsUUFBR0ksUUFBSDZFLElBQVlELElBQUFoQyxLQUFBLFNBQUFhLEdBQ1J4RCxFQUFBNkUsU0FBSW5CLGdCQUNKZCxNQUFBQSxTQUFBQSxHQUNINUMsRUFBQTZFLFNBQUEiLCJmaWxlIjoiY29udHJvbGxlcnMvdXNlcl9jdHJsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgbXVsdGVyID0gcmVxdWlyZShcIm11bHRlclwiKTsgLy8gaHR0cHM6Ly9naXRodWIuY29tL2V4cHJlc3Nqcy9tdWx0ZXJcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5jb25zdCBtZDUgPSByZXF1aXJlKCdtZDUnKTtcclxuaW1wb3J0IHVzZXJEYW8gZnJvbSBcIi4uL21vZGVscy91c2VyX21vZGVsc1wiO1xyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IHVwbG9hZEF2YXRhciA9IGFzeW5jIChyZXEsIHJlcykgPT4ge1xyXG4gICAgbGV0IHN0b3JhZ2VQYXRoID0gXCIvdXBsb2FkXCI7XHJcbiAgICBsZXQgc3RvcmFnZSA9IG11bHRlci5kaXNrU3RvcmFnZSh7XHJcbiAgICAgICAgZGVzdGluYXRpb246IChyZXEsIGZpbGUsIGNiKSA9PiB7XHJcbiAgICAgICAgICAgIGNiKG51bGwsIHBhdGguam9pbihfX2Rpcm5hbWUsIFwiLi4vLi4vc3RhdGljXCIsIHN0b3JhZ2VQYXRoKSlcclxuICAgICAgICB9LFxyXG4gICAgICAgIGZpbGVuYW1lOiAocmVxLCBmaWxlLCBjYikgPT4ge1xyXG4gICAgICAgICAgICBsZXQgdHlwZSA9IGZpbGUubWltZXR5cGUuc3BsaXQoXCIvXCIpWzFdO1xyXG4gICAgICAgICAgICBmaWxlLnN0b3JhZ2VQYXRoID0gc3RvcmFnZVBhdGg7XHJcbiAgICAgICAgICAgIGNiKG51bGwsIG1kNShKU09OLnN0cmluZ2lmeShmaWxlKSkgKyBcIi5cIiArIHR5cGUpXHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxuICAgIGxldCBmaWxlRmlsdGVyID0gYXN5bmMocmVxLCBmaWxlLCBjYikgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIC8vIOeUqOaIt+S/oeaBr+mqjOivgeaIkOWKnyzlhYHorrjkuIrkvKDmlofku7ZcclxuICAgICAgICAgICAgbGV0IHVzZXIgPSBhd2FpdCBzaWdudXBWYWxpZChyZXEsIHJlcyk7XHJcbiAgICAgICAgICAgIGNiKG51bGwsIHRydWUpXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAvLyDnlKjmiLfkv6Hmga/pqozor4HlpLHotKXvvIznpoHmraLkuIrkvKDmlofku7ZcclxuICAgICAgICAgICAgY2Ioe2NvZGU6MCxkYXRhOmV9LGZhbHNlKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNiKG5ldyBFcnJvcignSSBkb25cXCd0IGhhdmUgYSBjbHVlIScpKVxyXG4gICAgfVxyXG5cclxuICAgIGxldCB1cGxvYWQgPSBtdWx0ZXIoe1xyXG4gICAgICAgIHN0b3JhZ2U6IHN0b3JhZ2UsXHJcbiAgICAgICAgZmlsZUZpbHRlcjogZmlsZUZpbHRlclxyXG4gICAgfSkuc2luZ2xlKCdhdmF0YXInKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIHVwbG9hZChyZXEsIHJlcywgZXJyID0+IHtcclxuICAgICAgICAgICAgLy8g5aaC5p6c5rKh5pyJ5aS05YOP5paH5Lu2XHJcbiAgICAgICAgICAgIGlmKCFyZXEuZmlsZSl7XHJcbiAgICAgICAgICAgICAgICBzaWdudXBWYWxpZChyZXEsIHJlcykudGhlbihfdXNlciA9PntcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKF91c2VyKTtcclxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKG1zZyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG1zZylcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChlcnIgPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyDkuIrkvKDmiJDlip9cclxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIOemgeatouS4iuS8oFxyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVyci5kYXRhKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0pO1xyXG59O1xyXG5cclxuXHJcbmNvbnN0IHNpZ251cFZhbGlkID0gKHJlcSwgcmVzKSA9PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGxldCBfdXNlciA9IHJlcS5ib2R5O1xyXG4gICAgICAgIGlmIChfdXNlci51c2VybmFtZSA9PSBudWxsIHx8IF91c2VyLnVzZXJuYW1lID09IFwiXCIpIHtcclxuICAgICAgICAgICAgcmVqZWN0KFwi55So5oi35ZCN5LiN5Li656m6IVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKF91c2VyLnB3ZCA9PSBudWxsIHx8IF91c2VyLnB3ZCA9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChcIuWvhueggeS4jeS4uuepuiFcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChfdXNlci5zZXggPT0gbnVsbCB8fCBfdXNlci5zZXggPT0gXCJcIikge1xyXG4gICAgICAgICAgICByZWplY3QoXCLmgKfliKvkuI3kuLrnqbohXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoX3VzZXIuYmlydGhkYXkgPT0gbnVsbCB8fCBfdXNlci5iaXJ0aGRheSA9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIHJlamVjdChcIueUn+aXpeS4jeS4uuepuiFcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBfdXNlci5iaXJ0aGRheSA9IG5ldyBEYXRlKF91c2VyLmJpcnRoZGF5KS5nZXRUaW1lKCk7XHJcbiAgICAgICAgdXNlckRhby5maW5kT25lKHsgdXNlcm5hbWU6IF91c2VyLnVzZXJuYW1lIH0pLnRoZW4oZG9jcyA9PiB7XHJcbiAgICAgICAgICAgIGlmICghZG9jcykge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShfdXNlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoXCLor6XnlKjmiLflkI3lt7Lms6jlhows6K+36YeN5paw6L6T5YWlIVwiKTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICByZWplY3QoXCLms6jlhozlpLHotKUs6K+356iN5ZCO5YaN6K+VIVwiKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59O1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBzaWdudXAgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuXHJcbiAgICB1cGxvYWRBdmF0YXIocmVxLCByZXMpLnRoZW4oICgpID0+IHtcclxuICAgICAgICBsZXQgX3VzZXIgPSByZXEuYm9keTtcclxuICAgICAgICBfdXNlci5iaXJ0aGRheSA9IG5ldyBEYXRlKF91c2VyLmJpcnRoZGF5KS5nZXRUaW1lKCk7XHJcbiAgICAgICAgaWYocmVxLmZpbGUpe1xyXG4gICAgICAgICAgICBsZXQgX2ZpbGUgPSByZXEuZmlsZTtcclxuICAgICAgICAgICAgX3VzZXIuYXZhdGFyID0gX2ZpbGUuc3RvcmFnZVBhdGggKyBcIi9cIiArIF9maWxlLmZpbGVuYW1lO1xyXG4gICAgICAgIH1cclxuICAgICAgICB1c2VyRGFvLmFkZChfdXNlcikudGhlbihkYXRhID0+IHtcclxuICAgICAgICAgICAgbG9naW4ocmVxLCByZXMpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9KS5jYXRjaChlcnJNc2cgPT4ge1xyXG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiAwLCBtc2c6IGVyck1zZyB9KTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGxvZ2luID0gKHJlcSwgcmVzKSA9PiB7XHJcbiAgICBsZXQgcGFyYW1zID0gcmVxLmJvZHk7XHJcbiAgICBpZiAocGFyYW1zLnVzZXJuYW1lID09IG51bGwgfHwgcGFyYW1zLnVzZXJuYW1lID09IFwiXCIpIHtcclxuICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IDAsIG1zZzogJ+eUqOaIt+WQjeS4jeS4uuepuiEnIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHBhcmFtcy5wd2QgPT0gbnVsbCB8fCBwYXJhbXMucHdkID09IFwiXCIpIHtcclxuICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IDAsIG1zZzogJ+WvhueggeS4jeS4uuepuiEnIH0pO1xyXG4gICAgfVxyXG4gICAgdXNlckRhby5maW5kT25lKHsgdXNlcm5hbWU6IHBhcmFtcy51c2VybmFtZSB9KS50aGVuKGRvY3MgPT4ge1xyXG4gICAgICAgIGlmIChkb2NzKSB7XHJcbiAgICAgICAgICAgIGRvY3MudmFsaWRQYXNzd29yZChwYXJhbXMucHdkLCBpc0NoZWNrID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChpc0NoZWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVxLnNlc3Npb24udXNlciA9IGRvY3M7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiAxLCBtc2c6ICfnmbvlvZXmiJDlip8nIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oeyBzdGF0dXM6IDAsIG1zZzogJ+i0puWPt+aIluWvhueggemUmeivrycgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiAwLCBtc2c6ICfotKblj7fmiJblr4bnoIHplJnor68nIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKHsgc3RhdHVzOiAwLCBtc2c6ICfnmbvlvZXlpLHotKUnIH0pO1xyXG4gICAgfSlcclxufVxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBsb2dvdXQgPSAocmVxLCByZXMpID0+IHtcclxuICAgIHJlcy5jbGVhckNvb2tpZSgnVVNFUl9JRCcpO1xyXG4gICAgcmVxLnNlc3Npb24uZGVzdHJveShlcnIgPT4ge1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xyXG4gICAgfSk7XHJcblxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgZmluZEFsbFVzZXIgPSAocmVxLCByZXMsIG5leHQsIHRlbXBsYXRlKSA9PiB7XHJcblxyXG4gICAgdXNlckRhby5maW5kKGZhbHNlLCAoZXJyLCByZXN1bHQpID0+IHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHJlc3VsdClcclxuICAgICAgICByZXMucmVuZGVyKHRlbXBsYXRlLCB7IHRpdGxlOiAnRXhwcmVzcycsIHVzZXJMaXN0OiByZXN1bHQgfSk7XHJcbiAgICB9KVxyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGRlbGV0ZVVzZXIgPSAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIGxldCBpZCA9IHJlcS5wYXJhbXNbXCJpZFwiXTtcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgICByZXR1cm4gcmVzLnJlZGlyZWN0KFwiL3VzZXIvbGlzdFwiKTtcclxuICAgIH1cclxuICAgIHVzZXJEYW8ucmVtb3ZlKHsgX2lkOiBpZCB9KS50aGVuKGRvY3MgPT4ge1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdChcIi91c2VyL2xpc3RcIik7XHJcbiAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgIHJlcy5yZWRpcmVjdChcIi91c2VyL2xpc3RcIik7XHJcbiAgICB9KTtcclxufTsiXX0=
